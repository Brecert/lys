"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const TypeGraph_1 = require("./TypeGraph");
const nodes_1 = require("../nodes");
const typeResolvers_1 = require("./typeResolvers");
const types_1 = require("../types");
function fromTypeNode(node) {
    if (node instanceof nodes_1.Nodes.TypeReferenceNode) {
        return new types_1.TypeReference(node.name.name, node.closure);
    }
    return null;
}
exports.fromTypeNode = fromTypeNode;
class TypeGraphBuilder {
    constructor(parsingContext, parentGraph = null, expectedOutput = null) {
        this.parsingContext = parsingContext;
        this.parentGraph = parentGraph;
        this.expectedOutput = expectedOutput;
        this._nodes = [];
        this._referenceNode = [];
        //
    }
    createReferenceNode(node) {
        const resolver = typeResolvers_1.getTypeResolver(node);
        const result = this.createNode(node, resolver);
        return result;
    }
    createNode(node, resolver) {
        if (this._nodes.some($ => $.astNode == node)) {
            throw new Error(`The node ${node.nodeName} already exist in _nodes`);
        }
        if (!resolver) {
            throw new Error(`The node ${node.nodeName} has no resolver`);
        }
        const result = new TypeGraph_1.TypeNode(node, resolver);
        this._nodes.push(result);
        return result;
    }
    build(node) {
        node.directives.forEach(node => {
            if (node instanceof nodes_1.Nodes.VarDirectiveNode) {
                this.processVarDecl(node.decl);
            }
            else if (node instanceof nodes_1.Nodes.OverloadedFunctionNode) {
                this.traverse(node);
            }
            else if (node instanceof nodes_1.Nodes.FunDirectiveNode) {
                throw new Error('Unreachable');
            }
            else if (node instanceof nodes_1.Nodes.TypeDirectiveNode) {
                this.processTypeDirective(node);
            }
        });
        return this.createTypeGraph();
    }
    buildFunctionNode(functionNode, args) {
        const paramList = functionNode.parameters;
        if (args.length != paramList.length) {
            paramList.forEach((param, index) => {
                if (index >= args.length) {
                    if (param.defaultValue) {
                        const paramNode = this.traverse(param.parameterName);
                        new TypeGraph_1.Edge(this.traverse(param.defaultValue), paramNode);
                    }
                    else {
                        this.createReferenceNode(param.parameterName);
                    }
                }
                else {
                    this.createNode(param.parameterName, new TypeGraph_1.LiteralTypeResolver(args[index]));
                }
            });
        }
        else {
            paramList.forEach((param, index) => {
                this.createNode(param.parameterName, new TypeGraph_1.LiteralTypeResolver(args[index]));
            });
        }
        const bodyNode = this.traverse(functionNode.body);
        const result = this.createNode(functionNode, new typeResolvers_1.PassThroughTypeResolver());
        new TypeGraph_1.Edge(bodyNode, result, void 0, this.expectedOutput);
        return this.createTypeGraph();
    }
    createTypeGraph() {
        this._referenceNode.forEach(({ result, reference }) => {
            const referencedType = this.resolveReferenceNode(reference);
            if (referencedType) {
                new TypeGraph_1.Edge(referencedType, result);
            }
            else {
                throw new Error('Unable to resolve reference to ' +
                    reference.referencedNode.name +
                    ' from ' +
                    (reference.moduleSource || 'local module'));
            }
        });
        return new TypeGraph_1.TypeGraph(this._nodes, this.parentGraph);
    }
    resolveReferenceNode(referenceNode) {
        //If no parent is a local reference else is a reference to another module.
        if (referenceNode.isLocalReference) {
            return this.findNode(referenceNode.referencedNode);
        }
        return null;
        // else {
        //   const parent: Nodes.NameIdentifierNode = referenceNode.moduleSource
        //   const module: PhaseResult[TypeCheckingResult[ModuleNode]] = parsingContext.getTypeCheckingForModule(parent.get)
        //   module.getResult().typeGraph.findNode(referenceNode.referencedNode)
        // }
    }
    resolveVariable(node, result) {
        const reference = node.closure.get(node.name);
        if (reference) {
            this._referenceNode.push({ reference, result });
        }
        else {
            this.parsingContext.error(`Invalid reference ${node.name}` /* InvalidReferenceMessage */, node);
        }
    }
    traverse(node) {
        return this.traverseNode(node, this.createReferenceNode(node));
    }
    traverseNode(node, target) {
        if (node instanceof nodes_1.Nodes.FunctionNode) {
            node.parameters.forEach(arg => {
                const defaultValue = arg.defaultValue;
                if (arg.parameterType) {
                    const expectedType = fromTypeNode(arg.parameterType);
                    const argumentNode = this.createNode(arg.parameterName, new TypeGraph_1.LiteralTypeResolver(expectedType));
                    new TypeGraph_1.Edge(argumentNode, target, arg.parameterName.name);
                    if (defaultValue) {
                        new TypeGraph_1.Edge(this.traverse(defaultValue), argumentNode, void 0, expectedType);
                    }
                }
                else {
                    this.parsingContext.error(`Parameter ${arg.parameterName.name} has no defined type`, node);
                }
            });
        }
        else if (node instanceof nodes_1.Nodes.OverloadedFunctionNode) {
            node.functions.forEach(fun => new TypeGraph_1.Edge(this.traverse(fun), target));
            new TypeGraph_1.Edge(target, this.traverse(node.functionName));
        }
        else if (node instanceof nodes_1.Nodes.VariableReferenceNode) {
            this.resolveVariable(node.variable, target);
        }
        else if (node instanceof nodes_1.Nodes.AssignmentNode) {
            // this.resolveVariable(node.variable.variable, target);
            new TypeGraph_1.Edge(this.traverse(node.variable), target, typeResolvers_1.EdgeLabels.LHS);
            new TypeGraph_1.Edge(this.traverse(node.value), target, typeResolvers_1.EdgeLabels.RHS);
        }
        else if (node instanceof nodes_1.Nodes.TypeReferenceNode) {
            this.resolveVariable(node.name, target);
        }
        else if (node instanceof nodes_1.Nodes.IfNode) {
            new TypeGraph_1.Edge(this.traverse(node.truePart), target, typeResolvers_1.EdgeLabels.TRUE_PART);
            new TypeGraph_1.Edge(this.traverse(node.condition), target, typeResolvers_1.EdgeLabels.CONDITION, new types_1.bool());
            if (node.falsePart) {
                new TypeGraph_1.Edge(this.traverse(node.falsePart), target, typeResolvers_1.EdgeLabels.FALSE_PART);
            }
        }
        else if (node instanceof nodes_1.Nodes.BinaryExpressionNode) {
            new TypeGraph_1.Edge(this.traverse(node.lhs), target, typeResolvers_1.EdgeLabels.LHS);
            new TypeGraph_1.Edge(this.traverse(node.rhs), target, typeResolvers_1.EdgeLabels.RHS);
        }
        else if (node instanceof nodes_1.Nodes.BlockNode) {
            node.statements.forEach($ => {
                new TypeGraph_1.Edge(this.traverse($), target, typeResolvers_1.EdgeLabels.STATEMENTS);
            });
        }
        else if (node instanceof nodes_1.Nodes.FunctionCallNode) {
            new TypeGraph_1.Edge(this.traverse(node.functionNode), target);
            node.argumentsNode.forEach(child => {
                new TypeGraph_1.Edge(this.traverse(child), target, typeResolvers_1.EdgeLabels.PARAMETER);
            });
        }
        else if (node instanceof nodes_1.Nodes.PatternMatcherNode) {
            const matched = this.traverse(node.lhs);
            new TypeGraph_1.Edge(matched, target, typeResolvers_1.EdgeLabels.PATTERN_EXPRESSION);
            node.matchingSet.forEach(child => {
                const source = this.traverse(child);
                new TypeGraph_1.Edge(source, target, typeResolvers_1.EdgeLabels.MATCH_EXPRESSION);
                new TypeGraph_1.Edge(matched, source, typeResolvers_1.EdgeLabels.PATTERN_MATCHING_VALUE);
            });
        }
        else if (node instanceof nodes_1.Nodes.VarDeclarationNode) {
            this.processVarDecl(node);
        }
        else if (node instanceof nodes_1.Nodes.MatchLiteralNode) {
            new TypeGraph_1.Edge(this.traverse(node.literal), target, typeResolvers_1.EdgeLabels.LHS);
            new TypeGraph_1.Edge(this.traverse(node.rhs), target, typeResolvers_1.EdgeLabels.RHS);
        }
        else if (node instanceof nodes_1.Nodes.MatchDefaultNode) {
            new TypeGraph_1.Edge(this.traverse(node.rhs), target, typeResolvers_1.EdgeLabels.RHS);
        }
        else
            this.traverseChildren(node, target);
        return target;
    }
    processVarDecl(decl) {
        const requiredType = (decl.variableType && fromTypeNode(decl.variableType)) || null;
        const variableNode = requiredType
            ? this.traverseNode(decl.variableName, this.createNode(decl.variableName, new TypeGraph_1.LiteralTypeResolver(requiredType)))
            : this.traverse(decl.variableName);
        const valueNode = this.traverse(decl.value);
        return new TypeGraph_1.Edge(valueNode, variableNode, void 0, requiredType);
    }
    processTypeDirective(directive) {
        if (directive.valueType) {
            if (directive.variableName.name in types_1.InjectableTypes) {
                this.parsingContext.error('You cannot redefine a built-in type', directive.valueType);
            }
            new TypeGraph_1.Edge(this.createReferenceNode(directive.valueType), this.traverse(directive.variableName));
        }
        else {
            if (directive.variableName.name in types_1.InjectableTypes) {
                const type = new types_1.InjectableTypes[directive.variableName.name]();
                directive.variableName.ofType = type;
                this.createNode(directive.variableName, new TypeGraph_1.LiteralTypeResolver(type));
            }
            else {
                this.parsingContext.error(`Cannot find built in type "${directive.variableName.name}"`, directive.variableName);
                this.createNode(directive.variableName, new TypeGraph_1.LiteralTypeResolver(types_1.VoidType.instance));
            }
        }
    }
    findNode(referenceNode) {
        const localNode = this.findLocalNode(referenceNode);
        return localNode || (this.parentGraph && this.parentGraph.findNode(referenceNode));
    }
    findLocalNode(referenceNode) {
        return this._nodes.find(node => node.astNode == referenceNode);
    }
    traverseChildren(node, result) {
        const children = node.children;
        return children.map(child => new TypeGraph_1.Edge(this.traverse(child), result));
    }
}
exports.TypeGraphBuilder = TypeGraphBuilder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVHlwZUdyYXBoQnVpbGRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIlR5cGVHcmFwaEJ1aWxkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwyQ0FBMkY7QUFFM0Ysb0NBQWlDO0FBQ2pDLG1EQUF1RjtBQUN2RixvQ0FBZ0Y7QUFFaEYsc0JBQTZCLElBQW9CO0lBQy9DLElBQUksSUFBSSxZQUFZLGFBQUssQ0FBQyxpQkFBaUIsRUFBRTtRQUMzQyxPQUFPLElBQUkscUJBQWEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7S0FDeEQ7SUFFRCxPQUFPLElBQUksQ0FBQztBQUNkLENBQUM7QUFORCxvQ0FNQztBQUVEO0lBSUUsWUFDUyxjQUE4QixFQUM5QixjQUF5QixJQUFJLEVBQzdCLGlCQUF1QixJQUFJO1FBRjNCLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUM5QixnQkFBVyxHQUFYLFdBQVcsQ0FBa0I7UUFDN0IsbUJBQWMsR0FBZCxjQUFjLENBQWE7UUFOcEMsV0FBTSxHQUFlLEVBQUUsQ0FBQztRQUN4QixtQkFBYyxHQUFpRCxFQUFFLENBQUM7UUFPaEUsRUFBRTtJQUNKLENBQUM7SUFFRCxtQkFBbUIsQ0FBQyxJQUFnQjtRQUNsQyxNQUFNLFFBQVEsR0FBaUIsK0JBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNyRCxNQUFNLE1BQU0sR0FBYSxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztRQUN6RCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDO0lBRUQsVUFBVSxDQUFDLElBQWdCLEVBQUUsUUFBc0I7UUFDakQsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLElBQUksSUFBSSxDQUFDLEVBQUU7WUFDNUMsTUFBTSxJQUFJLEtBQUssQ0FBQyxZQUFZ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Q0FBQztJQUVPLGFBQWEsQ0FBQyxhQUF5QjtRQUM3QyxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLE9BQU8sSUFBSSxhQUFhLENBQUMsQ0FBQztJQUNqRSxDQUFDO0lBRUQsZ0JBQWdCLENBQUMsSUFBZ0IsRUFBRSxNQUFnQjtRQUNqRCxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDO1FBQy9CLE9BQU8sUUFBUSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLElBQUksZ0JBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUM7SUFDdkUsQ0FBQztDQUNGO0FBbk9ELDRDQW1PQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFR5cGVOb2RlLCBUeXBlR3JhcGgsIFR5cGVSZXNvbHZlciwgRWRnZSwgTGl0ZXJhbFR5cGVSZXNvbHZlciB9IGZyb20gJy4vVHlwZUdyYXBoJztcbmltcG9ydCB7IFJlZmVyZW5jZSwgUGFyc2luZ0NvbnRleHQgfSBmcm9tICcuLi9jbG9zdXJlJztcbmltcG9ydCB7IE5vZGVzIH0gZnJvbSAnLi4vbm9kZXMnO1xuaW1wb3J0IHsgZ2V0VHlwZVJlc29sdmVyLCBFZGdlTGFiZWxzLCBQYXNzVGhyb3VnaFR5cGVSZXNvbHZlciB9IGZyb20gJy4vdHlwZVJlc29sdmVycyc7XG5pbXBvcnQgeyBib29sLCBUeXBlLCBJbmplY3RhYmxlVHlwZXMsIFZvaWRUeXBlLCBUeXBlUmVmZXJlbmNlIH0gZnJvbSAnLi4vdHlwZXMnO1xuXG5leHBvcnQgZnVuY3Rpb24gZnJvbVR5cGVOb2RlKG5vZGU6IE5vZGVzLlR5cGVOb2RlKTogVHlwZSB7XG4gIGlmIChub2RlIGluc3RhbmNlb2YgTm9kZXMuVHlwZVJlZmVyZW5jZU5vZGUpIHtcbiAgICByZXR1cm4gbmV3IFR5cGVSZWZlcmVuY2Uobm9kZS5uYW1lLm5hbWUsIG5vZGUuY2xvc3VyZSk7XG4gIH1cblxuICByZXR1cm4gbnVsbDtcbn1cblxuZXhwb3J0IGNsYXNzIFR5cGVHcmFwaEJ1aWxkZXIge1xuICBfbm9kZXM6IFR5cGVOb2RlW10gPSBbXTtcbiAgX3JlZmVyZW5jZU5vZGU6IHsgcmVmZXJlbmNlOiBSZWZlcmVuY2U7IHJlc3VsdDogVHlwZU5vZGUgfVtdID0gW107XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHVibGljIHBhcnNpbmdDb250ZXh0OiBQYXJzaW5nQ29udGV4dCxcbiAgICBwdWJsaWMgcGFyZW50R3JhcGg6IFR5cGVHcmFwaCA9IG51bGwsXG4gICAgcHVibGljIGV4cGVjdGVkT3V0cHV0OiBUeXBlID0gbnVsbFxuICApIHtcbiAgICAvL1xuICB9XG5cbiAgY3JlYXRlUmVmZXJlbmNlTm9kZShub2RlOiBOb2Rlcy5Ob2RlKTogVHlwZU5vZGUge1xuICAgIGNvbnN0IHJlc29sdmVyOiBUeXBlUmVzb2x2ZXIgPSBnZXRUeXBlUmVzb2x2ZXIobm9kZSk7XG4gICAgY29uc3QgcmVzdWx0OiBUeXBlTm9kZSA9IHRoaXMuY3JlYXRlTm9kZShub2RlLCByZXNvbHZlcik7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIGNyZWF0ZU5vZGUobm9kZTogTm9kZXMuTm9kZSwgcmVzb2x2ZXI6IFR5cGVSZXNvbHZlcik6IFR5cGVOb2RlIHtcbiAgICBpZiAodGhpcy5fbm9kZXMuc29tZSgkID0+ICQuYXN0Tm9kZSA9PSBub2RlKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgbm9kZSAke25vZGUubm9kZU5hbWV9IGFscmVhZHkgZXhpc3QgaW4gX25vZGVzYCk7XG4gICAgfVxuICAgIGlmICghcmVzb2x2ZXIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVGhlIG5vZGUgJHtub2RlLm5vZGVOYW1lfSBoYXMgbm8gcmVzb2x2ZXJgKTtcbiAgICB9XG4gICAgY29uc3QgcmVzdWx0ID0gbmV3IFR5cGVOb2RlKG5vZGUsIHJlc29sdmVyKTtcbiAgICB0aGlzLl9ub2Rlcy5wdXNoKHJlc3VsdCk7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIGJ1aWxkKG5vZGU6IE5vZGVzLkRvY3VtZW50Tm9kZSk6IFR5cGVHcmFwaCB7XG4gICAgbm9kZS5kaXJlY3RpdmVzLmZvckVhY2gobm9kZSA9PiB7XG4gICAgICBpZiAobm9kZSBpbnN0YW5jZW9mIE5vZGVzLlZhckRpcmVjdGl2ZU5vZGUpIHtcbiAgICAgICAgdGhpcy5wcm9jZXNzVmFyRGVjbChub2RlLmRlY2wpO1xuICAgICAgfSBlbHNlIGlmIChub2RlIGluc3RhbmNlb2YgTm9kZXMuT3ZlcmxvYWRlZEZ1bmN0aW9uTm9kZSkge1xuICAgICAgICB0aGlzLnRyYXZlcnNlKG5vZGUpO1xuICAgICAgfSBlbHNlIGlmIChub2RlIGluc3RhbmNlb2YgTm9kZXMuRnVuRGlyZWN0aXZlTm9kZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VucmVhY2hhYmxlJyk7XG4gICAgICB9IGVsc2UgaWYgKG5vZGUgaW5zdGFuY2VvZiBOb2Rlcy5UeXBlRGlyZWN0aXZlTm9kZSkge1xuICAgICAgICB0aGlzLnByb2Nlc3NUeXBlRGlyZWN0aXZlKG5vZGUpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHRoaXMuY3JlYXRlVHlwZUdyYXBoKCk7XG4gIH1cblxuICBidWlsZEZ1bmN0aW9uTm9kZShmdW5jdGlvbk5vZGU6IE5vZGVzLkZ1bmN0aW9uTm9kZSwgYXJnczogVHlwZVtdKTogVHlwZUdyYXBoIHtcbiAgICBjb25zdCBwYXJhbUxpc3QgPSBmdW5jdGlvbk5vZGUucGFyYW1ldGVycztcbiAgICBpZiAoYXJncy5sZW5ndGggIT0gcGFyYW1MaXN0Lmxlbmd0aCkge1xuICAgICAgcGFyYW1MaXN0LmZvckVhY2goKHBhcmFtLCBpbmRleCkgPT4ge1xuICAgICAgICBpZiAoaW5kZXggPj0gYXJncy5sZW5ndGgpIHtcbiAgICAgICAgICBpZiAocGFyYW0uZGVmYXVsdFZhbHVlKSB7XG4gICAgICAgICAgICBjb25zdCBwYXJhbU5vZGU6IFR5cGVOb2RlID0gdGhpcy50cmF2ZXJzZShwYXJhbS5wYXJhbWV0ZXJOYW1lKTtcbiAgICAgICAgICAgIG5ldyBFZGdlKHRoaXMudHJhdmVyc2UocGFyYW0uZGVmYXVsdFZhbHVlKSwgcGFyYW1Ob2RlKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5jcmVhdGVSZWZlcmVuY2VOb2RlKHBhcmFtLnBhcmFtZXRlck5hbWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLmNyZWF0ZU5vZGUocGFyYW0ucGFyYW1ldGVyTmFtZSwgbmV3IExpdGVyYWxUeXBlUmVzb2x2ZXIoYXJnc1tpbmRleF0pKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHBhcmFtTGlzdC5mb3JFYWNoKChwYXJhbSwgaW5kZXgpID0+IHtcbiAgICAgICAgdGhpcy5jcmVhdGVOb2RlKHBhcmFtLnBhcmFtZXRlck5hbWUsIG5ldyBMaXRlcmFsVHlwZVJlc29sdmVyKGFyZ3NbaW5kZXhdKSk7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBib2R5Tm9kZTogVHlwZU5vZGUgPSB0aGlzLnRyYXZlcnNlKGZ1bmN0aW9uTm9kZS5ib2R5KTtcbiAgICBjb25zdCByZXN1bHQgPSB0aGlzLmNyZWF0ZU5vZGUoZnVuY3Rpb25Ob2RlLCBuZXcgUGFzc1Rocm91Z2hUeXBlUmVzb2x2ZXIoKSk7XG4gICAgbmV3IEVkZ2UoYm9keU5vZGUsIHJlc3VsdCwgdm9pZCAwLCB0aGlzLmV4cGVjdGVkT3V0cHV0KTtcbiAgICByZXR1cm4gdGhpcy5jcmVhdGVUeXBlR3JhcGgoKTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlVHlwZUdyYXBoKCk6IFR5cGVHcmFwaCB7XG4gICAgdGhpcy5fcmVmZXJlbmNlTm9kZS5mb3JFYWNoKCh7IHJlc3VsdCwgcmVmZXJlbmNlIH0pID0+IHtcbiAgICAgIGNvbnN0IHJlZmVyZW5jZWRUeXBlOiBUeXBlTm9kZSA9IHRoaXMucmVzb2x2ZVJlZmVyZW5jZU5vZGUocmVmZXJlbmNlKTtcbiAgICAgIGlmIChyZWZlcmVuY2VkVHlwZSkge1xuICAgICAgICBuZXcgRWRnZShyZWZlcmVuY2VkVHlwZSwgcmVzdWx0KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAnVW5hYmxlIHRvIHJlc29sdmUgcmVmZXJlbmNlIHRvICcgK1xuICAgICAgICAgICAgcmVmZXJlbmNlLnJlZmVyZW5jZWROb2RlLm5hbWUgK1xuICAgICAgICAgICAgJyBmcm9tICcgK1xuICAgICAgICAgICAgKHJlZmVyZW5jZS5tb2R1bGVTb3VyY2UgfHwgJ2xvY2FsIG1vZHVsZScpXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIG5ldyBUeXBlR3JhcGgodGhpcy5fbm9kZXMsIHRoaXMucGFyZW50R3JhcGgpO1xuICB9XG5cbiAgcmVzb2x2ZVJlZmVyZW5jZU5vZGUocmVmZXJlbmNlTm9kZTogUmVmZXJlbmNlKTogVHlwZU5vZGUgfCBudWxsIHtcbiAgICAvL0lmIG5vIHBhcmVudCBpcyBhIGxvY2FsIHJlZmVyZW5jZSBlbHNlIGlzIGEgcmVmZXJlbmNlIHRvIGFub3RoZXIgbW9kdWxlLlxuICAgIGlmIChyZWZlcmVuY2VOb2RlLmlzTG9jYWxSZWZlcmVuY2UpIHtcbiAgICAgIHJldHVybiB0aGlzLmZpbmROb2RlKHJlZmVyZW5jZU5vZGUucmVmZXJlbmNlZE5vZGUpO1xuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgICAvLyBlbHNlIHtcbiAgICAvLyAgIGNvbnN0IHBhcmVudDogTm9kZXMuTmFtZUlkZW50aWZpZXJOb2RlID0gcmVmZXJlbmNlTm9kZS5tb2R1bGVTb3VyY2VcbiAgICAvLyAgIGNvbnN0IG1vZHVsZTogUGhhc2VSZXN1bHRbVHlwZUNoZWNraW5nUmVzdWx0W01vZHVsZU5vZGVdXSA9IHBhcnNpbmdDb250ZXh0LmdldFR5cGVDaGVja2luZ0Zvck1vZHVsZShwYXJlbnQuZ2V0KVxuICAgIC8vICAgbW9kdWxlLmdldFJlc3VsdCgpLnR5cGVHcmFwaC5maW5kTm9kZShyZWZlcmVuY2VOb2RlLnJlZmVyZW5jZWROb2RlKVxuICAgIC8vIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVzb2x2ZVZhcmlhYmxlKG5vZGU6IE5vZGVzLk5hbWVJZGVudGlmaWVyTm9kZSwgcmVzdWx0OiBUeXBlTm9kZSk6IHZvaWQge1xuICAgIGNvbnN0IHJlZmVyZW5jZSA9IG5vZGUuY2xvc3VyZS5nZXQobm9kZS5uYW1lKTtcbiAgICBpZiAocmVmZXJlbmNlKSB7XG4gICAgICB0aGlzLl9yZWZlcmVuY2VOb2RlLnB1c2goeyByZWZlcmVuY2UsIHJlc3VsdCB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5wYXJzaW5nQ29udGV4dC5lcnJvcihgSW52YWxpZCByZWZlcmVuY2UgJHtub2RlLm5hbWV9YCAvKiBJbnZhbGlkUmVmZXJlbmNlTWVzc2FnZSAqLywgbm9kZSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB0cmF2ZXJzZShub2RlOiBOb2Rlcy5Ob2RlKTogVHlwZU5vZGUge1xuICAgIHJldHVybiB0aGlzLnRyYXZlcnNlTm9kZShub2RlLCB0aGlzLmNyZWF0ZVJlZmVyZW5jZU5vZGUobm9kZSkpO1xuICB9XG5cbiAgcHJpdmF0ZSB0cmF2ZXJzZU5vZGUobm9kZTogTm9kZXMuTm9kZSwgdGFyZ2V0OiBUeXBlTm9kZSk6IFR5cGVOb2RlIHtcbiAgICBpZiAobm9kZSBpbnN0YW5jZW9mIE5vZGVzLkZ1bmN0aW9uTm9kZSkge1xuICAgICAgbm9kZS5wYXJhbWV0ZXJzLmZvckVhY2goYXJnID0+IHtcbiAgICAgICAgY29uc3QgZGVmYXVsdFZhbHVlOiBOb2Rlcy5Ob2RlID0gYXJnLmRlZmF1bHRWYWx1ZTtcbiAgICAgICAgaWYgKGFyZy5wYXJhbWV0ZXJUeXBlKSB7XG4gICAgICAgICAgY29uc3QgZXhwZWN0ZWRUeXBlID0gZnJvbVR5cGVOb2RlKGFyZy5wYXJhbWV0ZXJUeXBlKTtcbiAgICAgICAgICBjb25zdCBhcmd1bWVudE5vZGU6IFR5cGVOb2RlID0gdGhpcy5jcmVhdGVOb2RlKGFyZy5wYXJhbWV0ZXJOYW1lLCBuZXcgTGl0ZXJhbFR5cGVSZXNvbHZlcihleHBlY3RlZFR5cGUpKTtcbiAgICAgICAgICBuZXcgRWRnZShhcmd1bWVudE5vZGUsIHRhcmdldCwgYXJnLnBhcmFtZXRlck5hbWUubmFtZSk7XG4gICAgICAgICAgaWYgKGRlZmF1bHRWYWx1ZSkge1xuICAgICAgICAgICAgbmV3IEVkZ2UodGhpcy50cmF2ZXJzZShkZWZhdWx0VmFsdWUpLCBhcmd1bWVudE5vZGUsIHZvaWQgMCwgZXhwZWN0ZWRUeXBlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5wYXJzaW5nQ29udGV4dC5lcnJvcihgUGFyYW1ldGVyICR7YXJnLnBhcmFtZXRlck5hbWUubmFtZX0gaGFzIG5vIGRlZmluZWQgdHlwZWAsIG5vZGUpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9IGVsc2UgaWYgKG5vZGUgaW5zdGFuY2VvZiBOb2Rlcy5PdmVybG9hZGVkRnVuY3Rpb25Ob2RlKSB7XG4gICAgICBub2RlLmZ1bmN0aW9ucy5mb3JFYWNoKGZ1biA9PiBuZXcgRWRnZSh0aGlzLnRyYXZlcnNlKGZ1biksIHRhcmdldCkpO1xuICAgICAgbmV3IEVkZ2UodGFyZ2V0LCB0aGlzLnRyYXZlcnNlKG5vZGUuZnVuY3Rpb25OYW1lKSk7XG4gICAgfSBlbHNlIGlmIChub2RlIGluc3RhbmNlb2YgTm9kZXMuVmFyaWFibGVSZWZlcmVuY2VOb2RlKSB7XG4gICAgICB0aGlzLnJlc29sdmVWYXJpYWJsZShub2RlLnZhcmlhYmxlLCB0YXJnZXQpO1xuICAgIH0gZWxzZSBpZiAobm9kZSBpbnN0YW5jZW9mIE5vZGVzLkFzc2lnbm1lbnROb2RlKSB7XG4gICAgICAvLyB0aGlzLnJlc29sdmVWYXJpYWJsZShub2RlLnZhcmlhYmxlLnZhcmlhYmxlLCB0YXJnZXQpO1xuICAgICAgbmV3IEVkZ2UodGhpcy50cmF2ZXJzZShub2RlLnZhcmlhYmxlKSwgdGFyZ2V0LCBFZGdlTGFiZWxzLkxIUyk7XG4gICAgICBuZXcgRWRnZSh0aGlzLnRyYXZlcnNlKG5vZGUudmFsdWUpLCB0YXJnZXQsIEVkZ2VMYWJlbHMuUkhTKTtcbiAgICB9IGVsc2UgaWYgKG5vZGUgaW5zdGFuY2VvZiBOb2Rlcy5UeXBlUmVmZXJlbmNlTm9kZSkge1xuICAgICAgdGhpcy5yZXNvbHZlVmFyaWFibGUobm9kZS5uYW1lLCB0YXJnZXQpO1xuICAgIH0gZWxzZSBpZiAobm9kZSBpbnN0YW5jZW9mIE5vZGVzLklmTm9kZSkge1xuICAgICAgbmV3IEVkZ2UodGhpcy50cmF2ZXJzZShub2RlLnRydWVQYXJ0KSwgdGFyZ2V0LCBFZGdlTGFiZWxzLlRSVUVfUEFSVCk7XG4gICAgICBuZXcgRWRnZSh0aGlzLnRyYXZlcnNlKG5vZGUuY29uZGl0aW9uKSwgdGFyZ2V0LCBFZGdlTGFiZWxzLkNPTkRJVElPTiwgbmV3IGJvb2woKSk7XG5cbiAgICAgIGlmIChub2RlLmZhbHNlUGFydCkge1xuICAgICAgICBuZXcgRWRnZSh0aGlzLnRyYXZlcnNlKG5vZGUuZmFsc2VQYXJ0KSwgdGFyZ2V0LCBFZGdlTGFiZWxzLkZBTFNFX1BBUlQpO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAobm9kZSBpbnN0YW5jZW9mIE5vZGVzLkJpbmFyeUV4cHJlc3Npb25Ob2RlKSB7XG4gICAgICBuZXcgRWRnZSh0aGlzLnRyYXZlcnNlKG5vZGUubGhzKSwgdGFyZ2V0LCBFZGdlTGFiZWxzLkxIUyk7XG4gICAgICBuZXcgRWRnZSh0aGlzLnRyYXZlcnNlKG5vZGUucmhzKSwgdGFyZ2V0LCBFZGdlTGFiZWxzLlJIUyk7XG4gICAgfSBlbHNlIGlmIChub2RlIGluc3RhbmNlb2YgTm9kZXMuQmxvY2tOb2RlKSB7XG4gICAgICBub2RlLnN0YXRlbWVudHMuZm9yRWFjaCgkID0+IHtcbiAgICAgICAgbmV3IEVkZ2UodGhpcy50cmF2ZXJzZSgkKSwgdGFyZ2V0LCBFZGdlTGFiZWxzLlNUQVRFTUVOVFMpO1xuICAgICAgfSk7XG4gICAgfSBlbHNlIGlmIChub2RlIGluc3RhbmNlb2YgTm9kZXMuRnVuY3Rpb25DYWxsTm9kZSkge1xuICAgICAgbmV3IEVkZ2UodGhpcy50cmF2ZXJzZShub2RlLmZ1bmN0aW9uTm9kZSksIHRhcmdldCk7XG5cbiAgICAgIG5vZGUuYXJndW1lbnRzTm9kZS5mb3JFYWNoKGNoaWxkID0+IHtcbiAgICAgICAgbmV3IEVkZ2UodGhpcy50cmF2ZXJzZShjaGlsZCksIHRhcmdldCwgRWRnZUxhYmVscy5QQVJBTUVURVIpO1xuICAgICAgfSk7XG4gICAgfSBlbHNlIGlmIChub2RlIGluc3RhbmNlb2YgTm9kZXMuUGF0dGVybk1hdGNoZXJOb2RlKSB7XG4gICAgICBjb25zdCBtYXRjaGVkID0gdGhpcy50cmF2ZXJzZShub2RlLmxocyk7XG4gICAgICBuZXcgRWRnZShtYXRjaGVkLCB0YXJnZXQsIEVkZ2VMYWJlbHMuUEFUVEVSTl9FWFBSRVNTSU9OKTtcblxuICAgICAgbm9kZS5tYXRjaGluZ1NldC5mb3JFYWNoKGNoaWxkID0+IHtcbiAgICAgICAgY29uc3Qgc291cmNlID0gdGhpcy50cmF2ZXJzZShjaGlsZCk7XG4gICAgICAgIG5ldyBFZGdlKHNvdXJjZSwgdGFyZ2V0LCBFZGdlTGFiZWxzLk1BVENIX0VYUFJFU1NJT04pO1xuICAgICAgICBuZXcgRWRnZShtYXRjaGVkLCBzb3VyY2UsIEVkZ2VMYWJlbHMuUEFUVEVSTl9NQVRDSElOR19WQUxVRSk7XG4gICAgICB9KTtcbiAgICB9IGVsc2UgaWYgKG5vZGUgaW5zdGFuY2VvZiBOb2Rlcy5WYXJEZWNsYXJhdGlvbk5vZGUpIHtcbiAgICAgIHRoaXMucHJvY2Vzc1ZhckRlY2wobm9kZSk7XG4gICAgfSBlbHNlIGlmIChub2RlIGluc3RhbmNlb2YgTm9kZXMuTWF0Y2hMaXRlcmFsTm9kZSkge1xuICAgICAgbmV3IEVkZ2UodGhpcy50cmF2ZXJzZShub2RlLmxpdGVyYWwpLCB0YXJnZXQsIEVkZ2VMYWJlbHMuTEhTKTtcbiAgICAgIG5ldyBFZGdlKHRoaXMudHJhdmVyc2Uobm9kZS5yaHMpLCB0YXJnZXQsIEVkZ2VMYWJlbHMuUkhTKTtcbiAgICB9IGVsc2UgaWYgKG5vZGUgaW5zdGFuY2VvZiBOb2Rlcy5NYXRjaERlZmF1bHROb2RlKSB7XG4gICAgICBuZXcgRWRnZSh0aGlzLnRyYXZlcnNlKG5vZGUucmhzKSwgdGFyZ2V0LCBFZGdlTGFiZWxzLlJIUyk7XG4gICAgfSBlbHNlIHRoaXMudHJhdmVyc2VDaGlsZHJlbihub2RlLCB0YXJnZXQpO1xuXG4gICAgcmV0dXJuIHRhcmdldDtcbiAgfVxuXG4gIHByb2Nlc3NWYXJEZWNsKGRlY2w6IE5vZGVzLlZhckRlY2xhcmF0aW9uTm9kZSk6IEVkZ2Uge1xuICAgIGNvbnN0IHJlcXVpcmVkVHlwZSA9IChkZWNsLnZhcmlhYmxlVHlwZSAmJiBmcm9tVHlwZU5vZGUoZGVjbC52YXJpYWJsZVR5cGUpKSB8fCBudWxsO1xuXG4gICAgY29uc3QgdmFyaWFibGVOb2RlOiBUeXBlTm9kZSA9IHJlcXVpcmVkVHlwZVxuICAgICAgPyB0aGlzLnRyYXZlcnNlTm9kZShkZWNsLnZhcmlhYmxlTmFtZSwgdGhpcy5jcmVhdGVOb2RlKGRlY2wudmFyaWFibGVOYW1lLCBuZXcgTGl0ZXJhbFR5cGVSZXNvbHZlcihyZXF1aXJlZFR5cGUpKSlcbiAgICAgIDogdGhpcy50cmF2ZXJzZShkZWNsLnZhcmlhYmxlTmFtZSk7XG5cbiAgICBjb25zdCB2YWx1ZU5vZGUgPSB0aGlzLnRyYXZlcnNlKGRlY2wudmFsdWUpO1xuXG4gICAgcmV0dXJuIG5ldyBFZGdlKHZhbHVlTm9kZSwgdmFyaWFibGVOb2RlLCB2b2lkIDAsIHJlcXVpcmVkVHlwZSk7XG4gIH1cblxuICBwcm9jZXNzVHlwZURpcmVjdGl2ZShkaXJlY3RpdmU6IE5vZGVzLlR5cGVEaXJlY3RpdmVOb2RlKSB7XG4gICAgaWYgKGRpcmVjdGl2ZS52YWx1ZVR5cGUpIHtcbiAgICAgIGlmIChkaXJlY3RpdmUudmFyaWFibGVOYW1lLm5hbWUgaW4gSW5qZWN0YWJsZVR5cGVzKSB7XG4gICAgICAgIHRoaXMucGFyc2luZ0NvbnRleHQuZXJyb3IoJ1lvdSBjYW5ub3QgcmVkZWZpbmUgYSBidWlsdC1pbiB0eXBlJywgZGlyZWN0aXZlLnZhbHVlVHlwZSk7XG4gICAgICB9XG4gICAgICBuZXcgRWRnZSh0aGlzLmNyZWF0ZVJlZmVyZW5jZU5vZGUoZGlyZWN0aXZlLnZhbHVlVHlwZSksIHRoaXMudHJhdmVyc2UoZGlyZWN0aXZlLnZhcmlhYmxlTmFtZSkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoZGlyZWN0aXZlLnZhcmlhYmxlTmFtZS5uYW1lIGluIEluamVjdGFibGVUeXBlcykge1xuICAgICAgICBjb25zdCB0eXBlID0gbmV3IEluamVjdGFibGVUeXBlc1tkaXJlY3RpdmUudmFyaWFibGVOYW1lLm5hbWVdKCk7XG4gICAgICAgIGRpcmVjdGl2ZS52YXJpYWJsZU5hbWUub2ZUeXBlID0gdHlwZTtcbiAgICAgICAgdGhpcy5jcmVhdGVOb2RlKGRpcmVjdGl2ZS52YXJpYWJsZU5hbWUsIG5ldyBMaXRlcmFsVHlwZVJlc29sdmVyKHR5cGUpKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMucGFyc2luZ0NvbnRleHQuZXJyb3IoYENhbm5vdCBmaW5kIGJ1aWx0IGluIHR5cGUgXCIke2RpcmVjdGl2ZS52YXJpYWJsZU5hbWUubmFtZX1cImAsIGRpcmVjdGl2ZS52YXJpYWJsZU5hbWUpO1xuXG4gICAgICAgIHRoaXMuY3JlYXRlTm9kZShkaXJlY3RpdmUudmFyaWFibGVOYW1lLCBuZXcgTGl0ZXJhbFR5cGVSZXNvbHZlcihWb2lkVHlwZS5pbnN0YW5jZSkpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGZpbmROb2RlKHJlZmVyZW5jZU5vZGU6IE5vZGVzLk5vZGUpOiBUeXBlTm9kZSB8IG51bGwge1xuICAgIGNvbnN0IGxvY2FsTm9kZSA9IHRoaXMuZmluZExvY2FsTm9kZShyZWZlcmVuY2VOb2RlKTtcbiAgICByZXR1cm4gbG9jYWxOb2RlIHx8ICh0aGlzLnBhcmVudEdyYXBoICYmIHRoaXMucGFyZW50R3JhcGguZmluZE5vZGUocmVmZXJlbmNlTm9kZSkpO1xuICB9XG5cbiAgcHJpdmF0ZSBmaW5kTG9jYWxOb2RlKHJlZmVyZW5jZU5vZGU6IE5vZGVzLk5vZGUpOiBUeXBlTm9kZSB8IG51bGwge1xuICAgIHJldHVybiB0aGlzLl9ub2Rlcy5maW5kKG5vZGUgPT4gbm9kZS5hc3ROb2RlID09IHJlZmVyZW5jZU5vZGUpO1xuICB9XG5cbiAgdHJhdmVyc2VDaGlsZHJlbihub2RlOiBOb2Rlcy5Ob2RlLCByZXN1bHQ6IFR5cGVOb2RlKSB7XG4gICAgY29uc3QgY2hpbGRyZW4gPSBub2RlLmNoaWxkcmVuO1xuICAgIHJldHVybiBjaGlsZHJlbi5tYXAoY2hpbGQgPT4gbmV3IEVkZ2UodGhpcy50cmF2ZXJzZShjaGlsZCksIHJlc3VsdCkpO1xuICB9XG59XG4iXX0=